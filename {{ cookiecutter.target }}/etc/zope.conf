# This file was generated by "cookiecutter-zope-instance"
%define INSTANCEHOME ABSPATH({{ cookiecutter.target }})
instancehome $INSTANCEHOME

%define CLIENTHOME ABSPATH({{ cookiecutter.location_clienthome }})
clienthome $CLIENTHOME

debug-mode {{ "on" if cookiecutter.debug_mode == "True" else "off" }}
security-policy-implementation {{ "PYTHON" if cookiecutter.verbose_security == "True" else "C"}}
verbose-security {{ "on" if cookiecutter.verbose_security =="True" else "off" }}

default-zpublisher-encoding utf-8

{%- if cookiecutter.environment %}
<environment>
{%- for key, value in cookiecutter.environment|dictsort %}
    {{ key }} {{ value }}
{%- endfor %}

</environment>
{%- endif %}
# Database
<zodb_db main>
    mount-point /
    cache-size {{ cookiecutter.db_cache_size }}
{%- if cookiecutter.db_cache_size_bytes %}
    cache-size-bytes {{ cookiecutter.db_cache_size_bytes }}
{%- endif %}
{%- if cookiecutter.db_large_record_size %}
    large-record-size {{ cookiecutter.db_large_record_size }}
{%- endif %}
{%- if cookiecutter.db_pool_size %}
    pool-size {{ cookiecutter.db_pool_size }}
{%- endif %}
{%- if cookiecutter.db_storage == "direct" %}
    # Blob-enabled FileStorage database
    <filestorage>
        path ABSPATH({{ cookiecutter.db_filestorage_location}})
        blob-dir ABSPATH({{ cookiecutter.db_blobs_location }})
        pack-keep-old {{ "true" if cookiecutter.db_filestorage_pack_keep_old else "false" }}
{%- if cookiecutter.db_filestorage_quota %}
        quota {{ cookiecutter.db_filestorage_quota }}
{%- endif %}
{%- if cookiecutter.db_filestorage_packer %}
        packer {{ cookiecutter.db_filestorage_packer }}
{%- endif %}
{%- if cookiecutter.db_filestorage_pack_gc %}
        pack-gc {{ cookiecutter.db_filestorage_pack_gc }}
{%- endif %}
    </filestorage>
{%- endif %}
{%- if cookiecutter.db_storage == "relstorage" %}
    # RelStorage
    %import relstorage
    <relstorage>
        # blobs
        shared-blob-dir {{ "true" if cookiecutter.db_blobs_mode == "shared" else "false" }}
        blob-dir ABSPATH({{ cookiecutter.db_blobs_location }})
        # general settings
        keep-history {{ cookiecutter.db_relstorage_keep_history|lower }}
        read-only {{ cookiecutter.db_relstorage_read_only|lower }}
        create-schema {{ cookiecutter.db_relstorage_create_schema|lower}}
{%- if cookiecutter.db_relstorage_commit_lock_timeout %}
        commit-lock-timeout {{ cookiecutter.db_relstorage_commit_lock_timeout }}
{%- endif %}
{%- if cookiecutter.db_relstorage_blob_cache_size_check_external %}
        blob-cache-size-check-external {{ cookiecutter.db_relstorage_blob_cache_size_check_external }}
{%- endif %}
{%- if cookiecutter.db_relstorage_blob_chunk_size %}
        blob-chunk-size {{ cookiecutter.db_relstorage_blob_chunk_size }}
{%- endif %}
{%- if cookiecutter.db_relstorage_cache_local_mb %}
        cache-local-mb {{ cookiecutter.db_relstorage_cache_local_mb }}
{%- endif %}
{%- if cookiecutter.db_relstorage_cache_local_object_max %}
        cache-local-object-max {{ cookiecutter.db_relstorage_cache_local_object_max }}
{%- endif %}
{%- if cookiecutter.db_relstorage_cache_local_compression %}
        cache-local-compression {{ cookiecutter.db_relstorage_cache_local_compression }}
{%- endif %}
{%- if cookiecutter.db_relstorage_cache_local_dir %}
        cache-local-dir {{ cookiecutter.db_relstorage_cache_local_dir }}
{%- endif %}
{%- if cookiecutter.db_relstorage_cache_prefix %}
        cache-prefix {{ cookiecutter.db_relstorage_cache_prefix }}
{%- endif %}
{%- if cookiecutter.db_relstorage_replica_conf %}
        replica-conf {{ cookiecutter.db_relstorage_replica_conf }}
{%- endif %}
{%- if cookiecutter.db_relstorage_ro_replica_conf %}
        ro-replica-conf {{ cookiecutter.db_relstorage_ro_replica_conf }}
{%- endif %}
{%- if cookiecutter.db_relstorage_replica_timeout %}
        replica-timeout {{ cookiecutter.db_relstorage_replica_timeout }}
{%- endif %}
{%- if cookiecutter.db_relstorage_replica_revert_when_stale %}
        replica-revert-when-stale {{ cookiecutter.db_relstorage_replica_revert_when_stale }}
{%- endif %}
{%- if cookiecutter.db_relstorage_commit_lock_id %}
        # only relevant if oracle is used
        commit-lock-id {{ cookiecutter.db_relstorage_commit_lock_id }}
{%- endif %}
{%- if cookiecutter.db_relstorage == "postgresql" %}
        <postgresql>
            driver {{ cookiecutter.db_relstorage_postgresql_driver }}
            dsn {{ cookiecutter.db_relstorage_postgresql_dsn }}
        </postgresql>
{%- endif %}
{%- if cookiecutter.db_relstorage == "mysql" %}
        <mysql>
            driver {{ cookiecutter.db_relstorage_mysql_driver }}
{%- for key, value in cookiecutter.db_relstorage_mysql_parameters|dictsort %}
            {{ key }} {{ value }}
{%- endfor %}
        </mysql>
{%- endif %}
{%- if cookiecutter.db_relstorage == "oracle" %}
        <oracle>
            driver {{ cookiecutter.db_relstorage_oracle_driver }}
            user {{ cookiecutter.db_relstorage_oracle_user }}
            password {{ cookiecutter.db_relstorage_oracle_password }}
            dsn {{ cookiecutter.db_relstorage_oracle_dsn }}
        </oracle>
{%- endif %}
{%- if cookiecutter.db_relstorage == "sqlite3" %}
        <sqlite3>
            driver {{ cookiecutter.db_relstorae_sqlite3_driver }}
            data_dir ABSPATH({{ cookiecutter.db_relstorae_sqlite3_data_dir }})
{%- if cookiecutter.db_relstorae_sqlite3_gevent_yield_interval %}
            gevent-yield-interval {{ cookiecutter.db_relstorae_sqlite3_gevent_yield_interval }}
{%- endif %}
{%- if cookiecutter.db_relstorae_sqlite3_pragma %}
            <pragma>
{%- for key, value in cookiecutter.db_relstorae_sqlite3_pragma|dictsort %}
                {{ key }} {{ value }}
{%- endfor %}
            </pragma>
{%- endif %}
        </sqlite3>
{%- endif %}
    </relstorage>
{%- endif %}
{%- if cookiecutter.db_storage == "zeo" %}
    # ZEO storage
    <zeoclient>
        # blobs
        shared-blob-dir {{ "true" if cookiecutter.db_blobs_mode == "shared" else "false" }}
        blob-dir ABSPATH({{ cookiecutter.db_blobs_location }})
        # general settings
        server {{ cookiecutter.db_zeo_server }}
        name {{ cookiecutter.db_zeo_name }}
{%- if cookiecutter.db_zeo_client %}
        # persistent caching
        client {{ cookiecutter.db_zeo_client }}
{%- if cookiecutter.db_zeo_var %}
        var {{ cookiecutter.db_zeo_var }}
{%- endif %}
{%- endif %}
{%- if cookiecutter.db_zeo_cache_size %}
        cache-size {{ cookiecutter.db_zeo_cache_size }}
{%- endif %}
{%- if cookiecutter.db_zeo_username %}
        # Authentication
        username {{ cookiecutter.db_zeo_username }}
        password {{ cookiecutter.db_zeo_password }}
{%- if cookiecutter.db_zeo_realm %}
        realm {{ cookiecutter.db_zeo_realm }}
{%- endif %}
{%- endif %}
        # Advanced options
{%- if cookiecutter.db_zeo_read_only_fallback %}
        read-only-fallback true
{%- endif %}
{%- if cookiecutter.db_zeo_read_only %}
        read-only true
{%- endif %}
{%- if cookiecutter.db_zeo_drop_cache_rather_verify %}
        drop-cache-rather-verify {{ cookiecutter.db_zeo_drop_cache_rather_verify }}
{%- endif %}
    </zeoclient>
{%- endif %}
</zodb_db>
{% for db in cookiecutter.mounted_dbs %}
<zodb_db db{{ db }}>
    cache-size 5000
    allow-implicit-cross-references false
    <zeoclient>
      blob-dir blob-dir ABSPATH({{ cookiecutter.db_blobs_location }})-db{{ db }}
      shared-blob-dir on
      server {{ cookiecutter.db_zeo_server }}
      storage {{ db }}
      name {{ db }}_zeostorage
      cache-size 30MB
    </zeoclient>
    mount-point /db{{ db }}
</zodb_db>
{%- endfor %}
